<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="static/chatting.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>

    <title>Document</title>
</head>
<style>
body, html {
height: 100%;
overflow-x: hidden;
}

.sidebar {
  height: 100%;
  overflow-x: hidden;
}

.user_message {
    margin-left: 25%;
    background-color: #0a5726;
    border: 1px solid #0a5726; border-radius: 12px;
}

.llm_message {
    margin-right: 25%;
    background-color: rgb(33, 33, 33);
    border: 1px solid rgb(33, 33, 33); border-radius: 12px;
}

.chat_list_item:hover {
    background-color: rgb(17, 17, 17);
}

.chat_list_text:hover {
    cursor: pointer;
}

.status-running {
    color: rgb(0, 255, 0);
}

.status-danger {
    color: red;
}

</style>
<body>
    <div class="modal fade" id="createChatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5">Create chat</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="CCModalActionStatusMessage" class="text-danger" style="display: none;">Error goes here...</p>
                
                <div class="form-group row mb-2">
                    <label for="maipHostname" class="col-sm-2 col-form-label">MAIP Host:</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="CCMaipHost" placeholder="0.0.0.0">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="maipPort" class="col-sm-2 col-form-label">MAIP Port:</label>
                    <div class="col-sm-10">
                      <input type="number" class="form-control" id="CCMaipPort" value="4554">
                    </div>
                </div>
                <div class="spinner-border" id="ccQuerySpinner" role="status" style="margin-left: 45%; display: none;">
                    
                </div>
                <div id="CCModelParams" style="display: none;">
                    <div class="form-group row mb-2">
                        <label for="maipHostname" class="col-sm-2 col-form-label">Selected Model:</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="CCSelectedModel">
                                
                            </select>
                        </div>
                    </div>
                    <div class="form-group row mb-2">
                        <label for="contextLength" class="col-sm-2 col-form-label">Context length:</label>
                        <div class="col-sm-10">
                          <input type="number" class="form-control" id="CCContextLength" value="4096">
                        </div>
                    </div>
                    <div class="form-group row mb-2">
                        <label for="contextLength" class="col-sm-2 col-form-label">Remember context:</label>
                        <div class="col-sm-10">
                            <input class="form-check-input" type="checkbox" value="" id="CCRemember">
                        </div>
                    </div>
                    <div class="form-group row mb-2">
                        <label for="systemPromptContainer" class="mb-2">System Prompt</label>
                        <textarea class="form-control" id="CCSysPrompt" rows="3" value="You are a helpful assistant.">You are a helpful assistant.</textarea>
                    </div>
                </div>  
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-success disabled" id="CCCreateButton" data-bs-dismiss="modal">Create</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
    </div>
    <div class="row h-100">
        <div class="sidebar col-sm-2 px-4 py-2" id="ChatSideBar">
            <div class="container-fluid w-100">
                <button type="button" class="btn btn-md" style="width: 100%; background-color: rgb(33, 33, 33);" data-bs-toggle="modal" data-bs-target="#createChatModal">
                    <strong>Create new chat
                    <i class="bi bi-chat-right-text"></i>
                    </strong>
                </button>
            </div>
            <hr>
            <!-- <div class="container-fluid">
                <div class="row border rounded mb-2">
                    <div class="col-10">
                        <div class="py-2">How to write a flask app in python</div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn text-start" style="width: 100%;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row border rounded mb-2">
                    <div class="col-10">
                        <div class="py-2">Hey, hey, hey</div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn text-start" style="width: 100%;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row border rounded mb-2">
                    <div class="col-10">
                        <div class="py-2">Harms of global warming.</div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn text-start" style="width: 100%;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div> -->
        </div>

        <div class="col-sm-8" style="height: 90%;">
            <div style="margin-top: 5%; margin-left: 10%; margin-right: 10%;">
                <button class="btn" data-bs-toggle="collapse" data-bs-target="#chatCollapse" aria-expanded="false" aria-controls="chatCollapse">
                    Chat Information
                </button>
                <div id="chatCollapse", class="collapse">
                    <div>
                        <div class="form-group row mb-2">
                            <label for="maipHostname" class="col-sm-2 col-form-label">MAIP Host:</label>
                            <div class="col-sm-10">
                              <input type="text" class="form-control" id="maipHostname" placeholder="0.0.0.0">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="maipPort" class="col-sm-2 col-form-label">MAIP Port:</label>
                            <div class="col-sm-10">
                              <input type="number" class="form-control" id="maipPort" value="4554">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="maipHostname" class="col-sm-2 col-form-label">Selected Model:</label>
                            <div class="col-sm-10">
                                <select class="form-control" id="selectModelContainer">
                                    
                                </select>
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="contextLength" class="col-sm-2 col-form-label">Context length:</label>
                            <div class="col-sm-10">
                              <input type="number" class="form-control" id="contextLength" value="4096">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="contextRemember" class="col-sm-2 col-form-label">Remember context:</label>
                            <div class="col-sm-10">
                                <input class="form-check-input" type="checkbox" value="" id="contextRemember">
                            </div>
                        </div>
                        <div class="form-group row mb-2">
                            <label for="systemPromptContainer" class="mb-2">System Prompt</label>
                            <textarea class="form-control" id="systemPromptContainer" rows="3" value="You are a helpful assistant."></textarea>
                        </div>
                    </div>
                </div>
                <hr>
                <div id="serverStatusDisplay">

                </div>
                <br>
                <div id="chat_container" style="overflow-y: scroll; max-height: 50em;">
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row-reverse mb-5">
                        <div class="p-2 user_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>
                    <div class="d-flex flex-row mb-5">
                        <div class="p-2 llm_message">Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis reiciendis placeat provident doloremque ex architecto possimus, qui earum iste molestias doloribus asperiores nam minus laboriosam ab, voluptatem perferendis. Laudantium, dolor.</div>
                    </div>

                </div>
            </div>
        </div>
        <div class="col-sm-2">
            
        </div>
    </div>
    <div class="fixed-bottom" style="position: absolute; left: 25%; bottom: 5%; right: 25%;">
        <div class="input-group">
            <input id="prompt_section" type="text" class="form-control rounded" placeholder="Your prompt here..." aria-label="Prompt" style="margin-right: 2%;">
            <div class="input-group-append">
                <button class="btn disabled" id="send_prompt_button">
                    <i class="bi bi-arrow-90deg-right h4"></i>
                </button>
            </div>
        </div>
    </div>
</body>
<script>
    // CC stands for Create Chat
    let givenPrompt = "";
    let chatContainer = document.getElementById("chat_container");
    let promptSection = document.getElementById("prompt_section");
    let promptSendButton = document.getElementById("send_prompt_button");
    let ccMaipHost = document.getElementById("CCMaipHost");
    let ccMaipPort = document.getElementById("CCMaipPort");
    let ccSelectedModel = document.getElementById("CCSelectedModel");
    let ccContextLength = document.getElementById("CCContextLength");
    let ccRememberContext = document.getElementById("CCRemember");
    let ccSystemPrompt = document.getElementById("CCSysPrompt");
    let ccModelParamsContainer = document.getElementById("CCModelParams");
    let ccQuerySpinner = document.getElementById("ccQuerySpinner");
    let ccCreateButton = document.getElementById("CCCreateButton");
    let modalErrorSection = document.getElementById("CCModalActionStatusMessage");
    let sideBarContainer = document.getElementById("ChatSideBar");

    let infoMaipHost = document.getElementById("maipHostname");
    let infoMaipPort = document.getElementById("maipPort");
    let infoSelectedModel = document.getElementById("selectModelContainer");
    let infoContextLength = document.getElementById("contextLength");
    let infoRememberContext = document.getElementById("contextRemember");
    let infoSystemPrompt = document.getElementById("systemPromptContainer");
    let infoServerStatus = document.getElementById("serverStatusDisplay");
    let activeChatId = "";

    const serverStatusChecker = new XMLHttpRequest();
    const chatHistoryChecker = new XMLHttpRequest();

    serverStatusChecker.onload = function(ev) {
        const serverResult = JSON.parse(this.responseText);
        if(serverResult.status == null)
        {
            infoServerStatus.innerHTML = `
                    <div>Server status: No response from backend <span class="status-running">●</span></div>  
            `;
        }

        if(serverResult.status.code != 0)
        {
            infoServerStatus.innerHTML = `
                    <div>Server status: Internal error(${serverResult.status.code}) <span class="status-running">●</span></div>  
            `;
            // backend inactive
        }
        else
        {
            const server_status = serverResult.server_status;
            if(server_status == 0)
            {
                infoServerStatus.innerHTML = `
                    <div>Server status: Running <span class="status-running">●</span></div>  
                `;
                // running
            }
            else if(server_status == 1)
            {
                infoServerStatus.innerHTML = `
                    <div>Server status: Connection failed <span class="status-danger">●</span></div>  
                `;
                // failed connection
            }
            else if(server_status == 2)
            {
                infoServerStatus.innerHTML = `
                    <div>Server status: Client initialization failed <span class="status-danger">●</span></div>  
                `;
                // cant initialize client
            }
            else if(server_status == 3)
            {
                infoServerStatus.innerHTML = `
                    <div>Server status: Model is not supported (${infoSelectedModel.value})<span class="status-danger">●</span></div>  
                `;
                let modelOptionList = "";
                for(let i = 0; i < serverResult.models.length; i++)
                {
                    modelOptionList += `
                        <option>${serverResult.models[i]}</option>
                    `;
                }
                infoSelectedModel.innerHTML = modelOptionList;
                infoSelectedModel.value = "";
                // model not supported
            }
            else
            {
                infoServerStatus.innerHTML = `
                    <div>Server status: Unknown error <span class="status-danger">●</span></div>  
                `;
                // do nothing
            }
        }
    }
    
    chatHistoryChecker.onload = function() {
        const serverResult = JSON.parse(this.responseText);
        if(serverResult.message_history == null)
        {
            
        }
        else
        {
            
            for(let i = 0; i < serverResult.message_history.length; i++)
            {
                add_chat_message(serverResult.message_history[i].msg_content, serverResult.message_history[i].msg_role);
            }
        }
    }

    function modal_display_model_params()
    {
        let maipHost = ccMaipHost.value;
        let maipPort = ccMaipPort.value;

        if(!maipHost.length)
        {
            modalErrorSection.innerHTML = "*Missing maip host.";
        }

        if(!maipPort.length)
        {
            modalErrorSection.innerHTML = "*Missing maip port.";
        }

        let modelQueryUrl = "/maip/get_models?maip_host=" + maipHost + "&maip_port=" + maipPort;
        modalErrorSection.style.display = "none";
        ccModelParamsContainer.style.display = "none";
        ccQuerySpinner.style.display = "block";
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function(ev) {
            const serverResult = JSON.parse(this.responseText);
            ccQuerySpinner.style.display = "none";
            if(serverResult.status.code != 0)
            {
                modalErrorSection.innerHTML = serverResult.status.message + " (" + serverResult.status.code + ")";
                modalErrorSection.style.display = "block";
            }
            else
            {
                ccModelParamsContainer.style.display = "block";
                let optionsString = "";
                for(let i = 0; i < serverResult.models.length; i++)
                {
                    optionsString += `
                        <option value="${serverResult.models[i]}">${serverResult.models[i]}</option>
                    `;
                }
                ccSelectedModel.innerHTML = optionsString;
                ccCreateButton.className = "btn btn-success";
            }
        }
        xhttp.open("GET", modelQueryUrl);
        xhttp.send();
    }

    function create_chat()
    {
        const chatCreateUrl = `
            /chat/create?maip_host=${ccMaipHost.value}&maip_port=${ccMaipPort.value}&selected_model=${ccSelectedModel.value}&ctx_length=${ccContextLength.value}&ctx_remember=${ccRememberContext.checked}&system_prompt=${ccSystemPrompt.value}
        `;
        
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function(ev) {
            const serverResult = JSON.parse(this.responseText);
        }

        xhttp.open("POST", chatCreateUrl);
        xhttp.send();
    }

    function load_chat_list()
    {
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function(ev) {
            const serverResult = JSON.parse(this.responseText);
            ccQuerySpinner.style.display = "none";
            if(serverResult.status.code != 0)
            {
                
            }

            else
            {
                const active_chat_list = serverResult.chat_list;
                for(let i = 0; i < active_chat_list.length; i++)
                {
                    let containerGeneral = document.createElement("div");
                    let roundedContainer = document.createElement("div");
                    let textColumn = document.createElement("div");
                    let trashIconColumn = document.createElement("div");
                    
                    containerGeneral.className = "container-fluid chat_list_item";
                    roundedContainer.className = "row border rounded mb-2";
                    textColumn.className = "col-10 chat_list_text";
                    trashIconColumn.className = "col-2";
                    
                    containerGeneral.id = active_chat_list[i].context_id;
                    textColumn.id = active_chat_list[i].context_id;

                    textColumn.addEventListener("click", open_chat);

                    textColumn.innerHTML = `<div class="py-2">${active_chat_list[i].context_id}</div>`;
                    trashIconColumn.innerHTML = `<button type="button" class="btn text-start" style="width: 100%;" id="${active_chat_list[i].context_id}">
                            <i class="bi bi-trash"></i>
                        </button>`;    
                    roundedContainer.appendChild(textColumn);
                    roundedContainer.appendChild(trashIconColumn);
                    containerGeneral.appendChild(roundedContainer);
                    sideBarContainer.appendChild(containerGeneral);
                }
            }
        }

        xhttp.open("GET", "/chat/get_chats");
        xhttp.send();
    }

    function open_chat()
    {
        const chatId = this.id;
        serverStatusChecker.abort();
        chatHistoryChecker.abort();
        const xhttp = new XMLHttpRequest();
        infoServerStatus.innerHTML = `<div>Server status:<div class="spinner-border" role="status" style="width: 1em; height: 1em;"></div></div>`;
        xhttp.onload = function(ev) {
            const serverResult = JSON.parse(this.responseText);
            if(serverResult.status.code != 0)
            {
                
            }
            else
            {
                const statusRequest = `/maip/server_status?maip_host=${serverResult.chat_info.maip_host}&maip_port=${serverResult.chat_info.maip_port}&selected_model=${serverResult.chat_info.selected_model}`;
                serverStatusChecker.open("GET", statusRequest);
                serverStatusChecker.send();
                chatHistoryChecker.open("GET", `/chat/get_chat_history/${serverResult.chat_info.context_id}`);
                chatHistoryChecker.send();
                activeChatId = serverResult.chat_info.context_id;
                infoMaipHost.value = serverResult.chat_info.maip_host;
                infoMaipHost.innerText = serverResult.chat_info.maip_host;

                infoMaipPort.value = serverResult.chat_info.maip_port;
                infoMaipPort.innerText = serverResult.chat_info.maip_port;

                infoContextLength.value = serverResult.chat_info.context_length;
                infoContextLength.innerText = serverResult.chat_info.context_length;
                if(serverResult.chat_info.context_remember)
                {   
                    infoRememberContext.checked = true;
                }
                else
                {
                    infoRememberContext.checked = false;
                }

                infoSystemPrompt.value = serverResult.chat_info.system_prompt;
                infoSystemPrompt.innerText = serverResult.chat_info.system_prompt;
                
                let optionString = `<option value="${serverResult.chat_info.selected_model}">${serverResult.chat_info.selected_model}</option>`

                infoSelectedModel.innerHTML = optionString;
            }
        }

        xhttp.open("GET", "/chat/get_chat_info/" + chatId);
        xhttp.send();
    }

    function promptEntryEvent(in_event)
    {
        givenPrompt = this.value;
        if(!givenPrompt.length)
        {
            promptSendButton.className = "btn disabled";
        }
        else
        {
            promptSendButton.className = "btn";
        }

        if(in_event.keyCode == 13)
        {
            promptSendButton.className = "btn disabled";
            givenPrompt = this.value;
            this.value = "";
            add_chat_message(givenPrompt);
        }
    }

    function promptSendButtonPress(in_event) 
    {
        if(promptSection.value.length)
        {
            givenPrompt = promptSection.value;
            this.className = "btn disabled";
            promptSection.value = "";
            add_chat_message(givenPrompt);
        }
    }

    function selected_model_change()
    {
        serverStatusChecker.abort();
        infoServerStatus.innerHTML = `<div>Server status:<div class="spinner-border" role="status" style="width: 1em; height: 1em;"></div></div>`;
        const statusRequest = `/maip/server_status?maip_host=${infoMaipHost.value}&maip_port=${infoMaipPort.value}&selected_model=${this.value}`;
        serverStatusChecker.open("GET", statusRequest);
        serverStatusChecker.send();
    }    

    promptSendButton.addEventListener("click", promptSendButtonPress);
    promptSection.addEventListener("keydown", promptEntryEvent);
    ccMaipPort.addEventListener("focusout", modal_display_model_params);
    ccCreateButton.addEventListener("click", create_chat);
    infoSelectedModel.addEventListener("change", selected_model_change);

    load_chat_list();

</script>

</html>